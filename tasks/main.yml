---
  - name: Install required software
    become: True
    when:
      - netconf is defined
      - netconf.if is defined
    apt: name={{ item }} state=present
    with_items:
      - bridge-utils
      - resolvconf
      - ifenslave
      - iproute2

  - name: Configure routing tables
    become: True
    template: src=rt_tables.j2 dest=/etc/iproute2/rt_tables owner=root group=root mode=0644
    when:
      - netconf is defined
      - netconf.rt is defined

  - name: Configure normal interfaces
    become: True
    template: src=if.j2 dest=/etc/network/interfaces.d/{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['if'] }}"
    when:
      - netconf is defined
      - netconf.if is defined

  - name: Configure bond interfaces
    become: True
    template: src=bond.j2 dest=/etc/network/interfaces.d/{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['bond'] }}"
    when:
      - netconf is defined
      - netconf.bond is defined

  - name: Configure vlan interfaces
    become: True
    template: src=vlan.j2 dest=/etc/network/interfaces.d/zz-{{ item.value.parent }}.{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['vlan'] }}"
    when:
      - netconf is defined
      - netconf.vlan is defined

  - name: Overwrite main network config file
    become: True
    template: src=interfaces.j2 dest=/etc/network/interfaces owner=root group=root mode=0644
    when:
      - netconf is defined
