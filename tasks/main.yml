---
  - name: Install required software
    become: True
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'if' in hostvars[inventory_hostname]['netconf']"
    apt: name={{ item }} state=present
    with_items:
      - bridge-utils
      - resolvconf
      - ifenslave
      - iproute2

  - name: Configure routing tables
    become: True
    template: src=rt_tables.j2 dest=/etc/iproute2/rt_tables owner=root group=root mode=0644
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'rt' in hostvars[inventory_hostname]['netconf']"

  - name: Configure normal interfaces
    become: True
    template: src=if.j2 dest=/etc/network/interfaces.d/{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['if'] }}"
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'if' in hostvars[inventory_hostname]['netconf']"

  - name: Configure bond interfaces
    become: True
    template: src=bond.j2 dest=/etc/network/interfaces.d/{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['bond'] }}"
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'bond' in hostvars[inventory_hostname]['netconf']"

  - name: Configure vlan interfaces
    become: True
    template: src=vlan.j2 dest=/etc/network/interfaces.d/yy-{{ item.value.parent }}.{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['vlan'] }}"
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'vlan' in hostvars[inventory_hostname]['netconf']"

  - name: Configure bridge interfaces
    become: True
    template: src=bridge.j2 dest=/etc/network/interfaces.d/zz-{{ item.key }} owner=root group=root mode=0644
    with_dict: "{{ hostvars[inventory_hostname]['netconf']['bridge'] }}"
    when:
      - "'netconf' in hostvars[inventory_hostname]"
      - "'bridge' in hostvars[inventory_hostname]['netconf']"

  - name: Overwrite main network config file
    become: True
    template: src=interfaces.j2 dest=/etc/network/interfaces owner=root group=root mode=0644
    when:
      - "'netconf' in hostvars[inventory_hostname]"
